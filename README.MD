# NOTIFIER V2

Notifier предназначен для отправки уведомлений в ралзиные системы общения. На данный момент поддерживаются email и telegram.

## 1. Содержание

1. [Содержание](#1-содержание)
2. [Установка](#21--установка)
3. [Настройка](#3-настройка)
4. [Использование](#4-использование)
    1. [V1](#41-v1) 
    2. [V2](#42-v2)



## 2.  Установка

Проект можно использовать как в ручной сборке, так и с помощью контейнеров докер.
Для запуска проекта через Nginx смотреть [здесь](#21-nginx).

Пример с использованием __docker-compose:__

```Docker
# version: '3.5'                #Old docker version support
services:
  notifier:
    container_name: notifier
    restart: unless-stopped
    build:
      context: .    
      args:                     #аргументы для сборки
        - BASE_URL=/notifier    #если требуется публикация в "подпапке", иначе не указывать
        - PROXY_HTTP=           #Если используется прокси
        - PROXY_HTTPS=          #Если используется прокси
    image: notifier
    ports:
      - 3000:3000               #Маппинг наружнего порта к внутреннему
    environment:
      - PORT=3000               #Внутренний порт сервера
      - PROXY_HTTP=             #Если используется прокси
      - PROXY_HTTPS=            #Если используется прокси
    volumes:
      - ./data:/notifier/data   #Том для сохранения данных вне контейнера
```

[наверх](#1-содержание)

### 2.1. Nginx

Для использования Nginx как прокси для проекта, минимальная настройка:

```nginx
location /notifier/ {
            proxy_pass http://localhost:3000/;
        }
```

где ***notifier*** - имя, которое должно совпадать с **BASE_URL** в настройках [docker-compose](#2-установка).

[наверх](#1-содержание)

## 3. Настройка

Логин/пароль по умолчанию: __admin/admin__.

После установки всё взаимодействие с сервисом возможно через встроенный WEB-итерфейс, либо через API. Перед использование каналов, необходимо настроить точки доступа к ним. Ниже приведено описание способа настроек для различных каналов с их особенностями.

### 3.1. Настройка telegram

Для настройки оповещения через telegram необходимо выполнить последовательность действий. Если у вас уже есть бот, которого вы хотите использовать, пункт 1 можно пропусть.

1. Создать бота в telegram через бота **@BotFather** передав команду ***/newbot***
2. Токен и название бота, необходимо добавить в настройки, в соответсвующих меню на сайте нотификатора
3. Настроить у бота инлайн режим (что бы иметь возможноть получать ид чатов и пользователей)
4. Добавить бота в нужную группу
5. \[Опционально, если вам не известны ИД в telegram\] Командой @\[Название_бота\], получите контекстные команды и там выберите **Покажи идентификаторы** для дальнейшего использования в рассылках.


[наверх](#1-содержание)

### 3.2. Настройка email

Для использования email-оповещения необходимо указать адрес сервера, порт, логин и пароль. Например настройка для esplus на момент публикации инструкции:

|Параметр|Значение|
---------|--------|
Сервер   |smr-ad01-cas.ad.ies-holding.com|
Порт     |25|

[наверх](#1-содержание)

## 4. Использование

### 4.1 V1

Для отправки увемодления, сервису необходимо отправть HTTP запрос:

```
POST http://host:port/api/notify

Заголовки

  Content-Type: application/json
  Authorization: Basic authdatta


Тело сообщения

  {
    "text":"Текст для отправки", -- обязательно
    "email":["email1@em.go","email2@em.go"], -- опиционально массив строк с email получателей
    "telegram":["-123123","1435435"], -- опционально массиов строк с telegramId получателей
    "groups":["gro1","gro2"], -- опционально массив строк названий группы рассылки получателей, группы настраиваются в web-интерфейсе    
  }
```

[наверх](#1-содержание)

### 4.2 V2

Пример кода в ./server/tests/sendAttachments.js
Для отправки увемодления, сервису необходимо отправть HTTP запрос:

_POST http://host:port/api/v2/notify_

Заголовки
```
  Content-Type: application/json
  Authorization: Basic authdatta
```
Тело сообщения

__Знак '?' означает что поле опционально__
```
  {
    message?: { -- объект сообщения для отправки
        text?: string,  -- текст по умолчанию, используется если не задан контент для канала
        telegram?: {  -- данные для телеграмма
            type: ParseMode,  -- тип контента "Markdown" | "MarkdownV2" | "HTML"
            content: string   -- сам контент
        },
        email?: { -- данные для электронного письма
            splitLetters: boolean,  -- отправить отдельными письмами (true), одним письмом(не указывать или false)
            from?: string,  -- адрес отправителя
            html?: string,  -- тело письма, можно использовать HTML разметку
            subject?: string, -- тема письма
        }
    },
    attachments?: [ -- вложения (файлы, изображения и т.д.)
      {
        type?: string, -- тип вложения, пока не используется
        name: string, -- название, как правило имя файла
        caption?: string,  -- используется в телеграмме для подписи к вложению, тип пока только текст
        cid?: string, -- идентификатор стоит указывать, если требуется внедрение документа в html код письма (например картинки)
        data: string  -- данные вложения, бинарные данные в формате BASE64        
      }
    ],
    emails?: string[] -- массив email 
    telegrams?: string[] -- массив ИД телеграмм
    groups?: string[] -- массив названий групп рассылки
  }
```

[наверх](#1-содержание)